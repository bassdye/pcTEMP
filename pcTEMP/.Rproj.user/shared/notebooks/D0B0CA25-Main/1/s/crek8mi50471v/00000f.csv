"0","if(exists(""number_treatments"")) {"
"0","  BAdat <- subset(prop_dat, phase == non_test_phase & treatment == non_test_treatment) "
"0","} else {"
"0","  BAdat <- subset(prop_dat, phase == non_test_phase) "
"0","}"
"0","BALR1_non <- BAdat$LRA1"
"0","BALR2_non <- BAdat$LRA2 "
"0","BALR3_non <- BAdat$LRA3"
"0","BALR4_non <- BAdat$LRA4"
"0",""
"0","CM_non <- rbind(BALR1_non, BALR2_non, BALR3_non, BALR4_non);"
"0",""
"0","# H1MAT - reduced model (m2); matrix of raw sums of squares and cross products calculated from the matrix 'CM' of log-ratios"
"0","# H2MAT - general model (m1); matrix of mean-corrected sums of squares and cross-products calculated from the matrix 'CM' of log-ratios"
"0","H1MAT <- H2MAT <- matrix(data= NA, nrow = 4, ncol = 4); "
"0","for (i in 1:4 ) {"
"0","  for (j in 1:4) {"
"0","    H1MAT[i, j] <- sum(CM_non[i, ]  * CM_non[j, ]);"
"0","    H2MAT[i, j] <- sum((CM_non[i, ] - mean(CM_non[i, ])) * (CM_non[j, ] - mean(CM_non[j, ])));"
"0","  };"
"0","};"
"0",""
"0","# Test for general preference (deviation from random use)"
"0","# -N*ln($) $=|r1|/|r2| ~ ln(det(H2MAT)/det(H1MAT)) ~ ln(general model/reduced model) from Aebischer et al. 1993"
"0","TEST <- -ncol(CM_non) * log(det(H2MAT) / det(H1MAT)); "
"0",""
"0","# By default, pchisq() gives the proportion of the distribution to the left of the value."
"0","# To get the proportion more extreme than your difference, you can specify lower.tail = FALSE or subtract the result from 1."
"0","# Used to compute cumulative chi square density for a vector of elements"
"0","# If significant (p<0.05), evidence for non-random use (null - no preference;  alternative - preference)"
"0","chi2_result <- 1 - pchisq(TEST, df = 4);"
"0",""
"0","if(exists(""number_treatments"")) {"
"0","  print(paste(""the chi square p value for phase"", non_test_phase, ""and treatment"", non_test_treatment, ""is ="", chi2_result))"
"0","} else {"
"0","  print(paste(""the chi square p value for phase"", non_test_phase, ""is ="", chi2_result))"
"0","}"
"1","[1]"
"1"," ""the chi square p value for phase I and treatment high is = 2.35367281220533e-14"""
"1","
"
"0","rm(H1MAT, H2MAT, TEST) # remove variables"
